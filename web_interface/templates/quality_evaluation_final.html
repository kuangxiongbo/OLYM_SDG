{% extends "base.html" %}

{% block title %}数据质量评估向导 - SDG 工具集{% endblock %}

{% block content %}
<div class="unified-wizard-page">
    <!-- 页面头部 -->
    <div class="page-header">
        <h1 class="page-title">数据质量评估向导</h1>
        <p class="page-description">四步完成数据质量评估，生成详细报告</p>
    </div>

        <!-- 向导步骤指示器 -->
        <div class="wizard-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-title">数据上传</div>
                <div class="step-description">上传原始数据和敏感数据</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-title">参数配置</div>
                <div class="step-description">配置质量评估参数</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-title">可视化评估</div>
                <div class="step-description">查看评估结果和图表</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-title">下载报告</div>
                <div class="step-description">下载评估报告</div>
            </div>
        </div>

        <!-- 向导内容区域 -->
        <div class="wizard-content">
        <!-- 步骤1：数据上传 -->
            <div class="wizard-step active" id="step-1">
                <div class="step-header">
                    <h2><i class="fas fa-upload"></i> 数据上传</h2>
                    <p>上传原始数据和敏感数据文件，支持CSV、Excel格式</p>
                </div>
                
                <div class="upload-section">
                            <div class="upload-area">
                    <h3>原始数据文件</h3>
                    <div class="file-upload-box" onclick="document.getElementById('original-file').click()">
                                    <i class="fas fa-cloud-upload-alt"></i>
                        <p>点击上传或拖拽文件到此处</p>
                        <small>支持 CSV、Excel 格式，最大 10MB</small>
                                        </div>
                    <input type="file" id="original-file" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(this, 'original')">
                    <div id="original-file-info" class="file-info" style="display: none;">
                                    <div class="file-details">
                            <span class="file-name"></span>
                            <span class="file-size"></span>
                            <span class="file-type"></span>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeFile('original')">移除</button>
                                    </div>
                                </div>
                
                <div class="upload-area">
                    <h3>敏感数据文件</h3>
                    <div class="file-upload-box" onclick="document.getElementById('sensitive-file').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>点击上传或拖拽文件到此处</p>
                        <small>支持 CSV、Excel 格式，最大 10MB</small>
                    </div>
                    <input type="file" id="sensitive-file" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(this, 'sensitive')">
                    <div id="sensitive-file-info" class="file-info" style="display: none;">
                                    <div class="file-details">
                            <span class="file-name"></span>
                            <span class="file-size"></span>
                            <span class="file-type"></span>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeFile('sensitive')">移除</button>
                    </div>
                </div>
            </div>

            <div class="upload-tips">
                <h4><i class="fas fa-info-circle"></i> 上传提示</h4>
                <ul>
                    <li>原始数据文件为脱敏前的基准数据</li>
                    <li>敏感数据文件为需要评估质量的脱敏数据</li>
                    <li>建议使用相同的数据结构以便对比分析</li>
                    <li>文件格式支持：CSV、Excel (.xlsx, .xls)</li>
                </ul>
            </div>
        </div>

        <!-- 步骤2：参数配置 -->
            <div class="wizard-step" id="step-2">
                <div class="step-header">
                <h2><i class="fas fa-cog"></i> 参数配置</h2>
                <p>配置质量评估的相关参数</p>
            </div>
            
            <div class="config-section">
                <div class="config-group">
                    <label>评估维度</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="dimensions" value="statistical" checked> 统计特征</label>
                        <label><input type="checkbox" name="dimensions" value="distribution" checked> 数据分布</label>
                        <label><input type="checkbox" name="dimensions" value="correlation" checked> 相关性</label>
                        <label><input type="checkbox" name="dimensions" value="privacy" checked> 隐私保护</label>
                    </div>
                </div>
                
                <div class="config-group">
                    <label>相似度阈值</label>
                    <input type="range" id="similarity-threshold" min="0.1" max="1.0" step="0.1" value="0.8">
                    <span id="similarity-value">0.8</span>
                </div>
                
                <div class="config-group">
                    <label>隐私保护级别</label>
                    <select id="privacy-level">
                        <option value="low">低</option>
                        <option value="medium" selected>中</option>
                        <option value="high">高</option>
                    </select>
                </div>
                </div>
            </div>

        <!-- 步骤3：可视化评估 -->
            <div class="wizard-step" id="step-3">
                <div class="step-header">
                <h2><i class="fas fa-chart-bar"></i> 可视化评估</h2>
                <p>查看数据质量评估结果和可视化图表</p>
            </div>
            
            <div class="evaluation-results">
                <div class="results-summary">
                    <h3>评估摘要</h3>
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-title">整体质量</div>
                            <div class="card-value" id="overall-quality">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-title">统计相似度</div>
                            <div class="card-value" id="statistical-similarity">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-title">分布相似度</div>
                            <div class="card-value" id="distribution-similarity">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="card-title">隐私保护度</div>
                            <div class="card-value" id="privacy-protection">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="charts-section">
                    <h3>可视化图表</h3>
                    <div class="charts-container">
                        <div class="chart-placeholder">
                            <i class="fas fa-chart-line"></i>
                            <p>统计特征对比图</p>
                        </div>
                        <div class="chart-placeholder">
                            <i class="fas fa-chart-pie"></i>
                            <p>数据分布对比图</p>
                        </div>
                        <div class="chart-placeholder">
                            <i class="fas fa-chart-area"></i>
                            <p>相关性分析图</p>
                        </div>
                    </div>
                </div>
                </div>
            </div>

        <!-- 步骤4：下载报告 -->
            <div class="wizard-step" id="step-4">
                <div class="step-header">
                <h2><i class="fas fa-download"></i> 下载报告</h2>
                <p>下载完整的数据质量评估报告</p>
            </div>
            
            <div class="download-section">
                <div class="report-preview">
                    <h3>报告预览</h3>
                    <div class="report-content">
                        <h4>数据质量评估报告</h4>
                        <p><strong>评估时间：</strong><span id="evaluation-time">-</span></p>
                        <p><strong>原始数据：</strong><span id="original-data-info">-</span></p>
                        <p><strong>敏感数据：</strong><span id="sensitive-data-info">-</span></p>
                        <p><strong>整体质量评分：</strong><span id="final-quality-score">-</span></p>
                        <p><strong>主要发现：</strong></p>
                        <ul id="key-findings">
                            <li>数据统计特征保持良好</li>
                            <li>分布相似度符合预期</li>
                            <li>隐私保护效果显著</li>
                        </ul>
                    </div>
                </div>
                
                <div class="download-options">
                    <h3>下载格式</h3>
                    <div class="download-buttons">
                        <button class="btn btn-primary" onclick="downloadReport('pdf')">
                            <i class="fas fa-file-pdf"></i> 下载PDF报告
                        </button>
                        <button class="btn btn-success" onclick="downloadReport('excel')">
                            <i class="fas fa-file-excel"></i> 下载Excel报告
                        </button>
                        <button class="btn btn-info" onclick="downloadReport('json')">
                            <i class="fas fa-file-code"></i> 下载JSON数据
                        </button>
                    </div>
                </div>
                </div>
            </div>
        </div>

    <!-- 向导导航 -->
        <div class="wizard-navigation">
            <button type="button" class="btn btn-secondary" id="prev-btn" onclick="prevStep()" disabled>
                <i class="fas fa-arrow-left"></i> 上一步
            </button>
            <div class="navigation-info">
                <span class="step-indicator">步骤 1 / 4</span>
            </div>
            <button type="button" class="btn btn-primary" id="next-btn" onclick="nextStep()">
                下一步 <i class="fas fa-arrow-right"></i>
            </button>
    </div>
</div>

<style>
.step-header {
    text-align: center;
    margin-bottom: 2rem;
}

.step-header h2 {
    color: #1B2951;
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
}

.step-header p {
    color: #666;
    font-size: 1rem;
}

.upload-section {
    max-width: 800px;
    margin: 0 auto;
}

.upload-area {
    margin-bottom: 2rem;
}

.upload-area h3 {
    color: #1B2951;
    margin-bottom: 1rem;
}

.file-upload-box {
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.file-upload-box:hover {
    border-color: #007bff;
    background: #e3f2fd;
}

.file-upload-box i {
    font-size: 3rem;
    color: #007bff;
    margin-bottom: 1rem;
}

.file-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #e8f5e8;
    border-radius: 5px;
    margin-top: 1rem;
}

.file-details {
    display: flex;
    gap: 1rem;
}

.upload-tips {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-top: 2rem;
}

.upload-tips h4 {
    color: #1B2951;
    margin-bottom: 1rem;
}

.upload-tips ul {
    margin: 0;
    padding-left: 1.5rem;
}

.upload-tips li {
    margin-bottom: 0.5rem;
    color: #666;
}

.config-section {
    max-width: 600px;
    margin: 0 auto;
}

.config-group {
    margin-bottom: 2rem;
}

.config-group label {
    display: block;
    font-weight: 600;
    color: #1B2951;
    margin-bottom: 0.5rem;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    font-weight: normal;
    cursor: pointer;
}

.checkbox-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

input[type="range"] {
    width: 100%;
    margin: 0.5rem 0;
}

select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.evaluation-results {
    max-width: 1000px;
    margin: 0 auto;
}

.results-summary {
    margin-bottom: 2rem;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.summary-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.card-title {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.card-value {
    color: #1B2951;
    font-size: 2rem;
    font-weight: bold;
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.chart-placeholder {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    color: #666;
}

.chart-placeholder i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #007bff;
}

.download-section {
    max-width: 800px;
    margin: 0 auto;
}

.report-preview {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.report-content h4 {
    color: #1B2951;
    margin-bottom: 1rem;
}

.report-content p {
    margin-bottom: 0.5rem;
}

.download-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #117a8b;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.875rem;
}

.btn:disabled {
    background: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
}

.btn:disabled:hover {
    background: #e9ecef;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 向导状态管理
let currentStep = 1;
const totalSteps = 4;
let wizardData = {
    originalFile: null,
    sensitiveFile: null,
    dimensions: ['statistical', 'distribution', 'correlation', 'privacy'],
    similarityThreshold: 0.8,
    privacyLevel: 'medium',
    evaluationResults: null
};

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    updateWizardUI();
    updateNavigationButtons();
    
    // 绑定相似度滑块事件
    const similaritySlider = document.getElementById('similarity-threshold');
    const similarityValue = document.getElementById('similarity-value');
    
    if (similaritySlider && similarityValue) {
        similaritySlider.addEventListener('input', function() {
            similarityValue.textContent = this.value;
            wizardData.similarityThreshold = parseFloat(this.value);
        });
    }
    
    // 绑定隐私级别选择事件
    const privacySelect = document.getElementById('privacy-level');
    if (privacySelect) {
        privacySelect.addEventListener('change', function() {
            wizardData.privacyLevel = this.value;
        });
    }
    
    // 绑定维度选择事件
    document.querySelectorAll('input[name="dimensions"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const selectedDimensions = Array.from(document.querySelectorAll('input[name="dimensions"]:checked'))
                .map(cb => cb.value);
            wizardData.dimensions = selectedDimensions;
        });
    });
});

// 更新向导UI
function updateWizardUI() {
    // 更新步骤指示器
    document.querySelectorAll('.wizard-steps .step').forEach((step, index) => {
        if (index + 1 === currentStep) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
    });
    
    // 更新步骤内容
    document.querySelectorAll('.wizard-step').forEach((step, index) => {
        if (index + 1 === currentStep) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
    });
    
    // 更新步骤指示器文本
    const stepIndicator = document.querySelector('.step-indicator');
    if (stepIndicator) {
        stepIndicator.textContent = `步骤 ${currentStep} / ${totalSteps}`;
    }
}

// 更新导航按钮状态
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    // 上一步按钮
    if (prevBtn) {
        prevBtn.disabled = currentStep === 1;
    }
    
    // 下一步按钮
    if (nextBtn) {
        const canProceed = canProceedToNextStep(currentStep);
        nextBtn.disabled = !canProceed || currentStep === totalSteps;
    }
}

// 检查是否可以进入下一步
function canProceedToNextStep(step) {
    switch(step) {
        case 1:
            return wizardData.originalFile !== null && wizardData.sensitiveFile !== null;
        case 2:
            return wizardData.dimensions.length > 0;
        case 3:
            return wizardData.evaluationResults !== null;
        case 4:
            return true;
        default:
            return false;
    }
}

// 下一步
function nextStep() {
    if (canProceedToNextStep(currentStep) && currentStep < totalSteps) {
        currentStep++;
        updateWizardUI();
        updateNavigationButtons();
        
        // 特殊处理
        if (currentStep === 3) {
            startEvaluation();
        } else if (currentStep === 4) {
            generateReport();
        }
    }
}

// 上一步
function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateWizardUI();
        updateNavigationButtons();
    }
}

// 跳转到指定步骤
function goToStep(step) {
    if (step >= 1 && step <= totalSteps) {
        currentStep = step;
        updateWizardUI();
        updateNavigationButtons();
    }
}

// 文件上传处理
function handleFileUpload(input, type) {
    const file = input.files[0];
    if (file) {
        wizardData[`${type}File`] = file;
        displayFileInfo(file, type);
        updateNavigationButtons();
    }
}

// 显示文件信息
function displayFileInfo(file, type) {
    const fileInfo = document.getElementById(`${type}-file-info`);
    const fileName = fileInfo.querySelector('.file-name');
    const fileSize = fileInfo.querySelector('.file-size');
    const fileType = fileInfo.querySelector('.file-type');
    
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileType.textContent = getFileTypeName(file.name);
    fileInfo.style.display = 'flex';
}

// 移除文件
function removeFile(type) {
    wizardData[`${type}File`] = null;
    document.getElementById(`${type}-file-info`).style.display = 'none';
    document.getElementById(`${type}-file`).value = '';
    updateNavigationButtons();
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 获取文件类型名称
function getFileTypeName(filename) {
    const ext = filename.toLowerCase().split('.').pop();
    switch (ext) {
        case 'csv':
            return 'CSV文件';
        case 'xlsx':
        case 'xls':
            return 'Excel文件';
        default:
            return '数据文件';
    }
}

// 开始评估
function startEvaluation() {
    // 模拟评估过程
    setTimeout(() => {
        wizardData.evaluationResults = {
            overallQuality: 85,
            statisticalSimilarity: 88,
            distributionSimilarity: 82,
            privacyProtection: 90
        };
        
        // 更新结果显示
        document.getElementById('overall-quality').textContent = '85%';
        document.getElementById('statistical-similarity').textContent = '88%';
        document.getElementById('distribution-similarity').textContent = '82%';
        document.getElementById('privacy-protection').textContent = '90%';
        
        updateNavigationButtons();
    }, 1000);
}

// 生成报告
function generateReport() {
    const now = new Date();
    document.getElementById('evaluation-time').textContent = now.toLocaleString();
    document.getElementById('original-data-info').textContent = wizardData.originalFile ? wizardData.originalFile.name : '-';
    document.getElementById('sensitive-data-info').textContent = wizardData.sensitiveFile ? wizardData.sensitiveFile.name : '-';
    document.getElementById('final-quality-score').textContent = wizardData.evaluationResults ? wizardData.evaluationResults.overallQuality + '%' : '-';
}

// 下载报告
function downloadReport(format) {
    alert(`下载${format.toUpperCase()}格式报告功能待实现`);
}

// 绑定步骤点击事件
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.wizard-steps .step').forEach((step, index) => {
        step.addEventListener('click', () => {
            if (index + 1 <= currentStep) {
                goToStep(index + 1);
            }
        });
    });
});
</script>
{% endblock %}