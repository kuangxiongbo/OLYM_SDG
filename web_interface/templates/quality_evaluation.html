{% extends "base_new.html" %}

{% block title %}质量评估 - SDG多账号控制系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-chart-line me-2"></i>质量评估
                </h2>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="showHelp()">
                        <i class="fas fa-question-circle me-2"></i>帮助
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showHistory()">
                        <i class="fas fa-history me-2"></i>历史记录
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 工具说明 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>工具说明
                </h6>
                <p class="mb-0">
                    全面评估合成数据质量，包括统计相似度、分布对比、相关性保持等多个维度的质量指标。
                    帮助您了解合成数据的质量和可靠性。
                </p>
            </div>
        </div>
    </div>

    <!-- 数据选择 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-database me-2"></i>步骤1: 选择对比数据
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="originalDataSource" class="form-label">原始数据源</label>
                                <select class="form-select" id="originalDataSource">
                                    <option value="">请选择原始数据源</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="syntheticDataSource" class="form-label">合成数据源</label>
                                <select class="form-select" id="syntheticDataSource">
                                    <option value="">请选择合成数据源</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>注意：</strong>确保原始数据和合成数据具有相同的列结构和数据类型，以获得准确的评估结果。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 评估配置 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>步骤2: 评估配置
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>统计指标</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="meanComparison" checked>
                                <label class="form-check-label" for="meanComparison">
                                    均值对比
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="varianceComparison" checked>
                                <label class="form-check-label" for="varianceComparison">
                                    方差对比
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="skewnessComparison" checked>
                                <label class="form-check-label" for="skewnessComparison">
                                    偏度对比
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="kurtosisComparison" checked>
                                <label class="form-check-label" for="kurtosisComparison">
                                    峰度对比
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>分布指标</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ksTest" checked>
                                <label class="form-check-label" for="ksTest">
                                    Kolmogorov-Smirnov检验
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chiSquareTest" checked>
                                <label class="form-check-label" for="chiSquareTest">
                                    卡方检验
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="wassersteinDistance" checked>
                                <label class="form-check-label" for="wassersteinDistance">
                                    Wasserstein距离
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="jensenShannonDivergence" checked>
                                <label class="form-check-label" for="jensenShannonDivergence">
                                    Jensen-Shannon散度
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>相关性指标</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pearsonCorrelation" checked>
                                <label class="form-check-label" for="pearsonCorrelation">
                                    Pearson相关系数
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="spearmanCorrelation" checked>
                                <label class="form-check-label" for="spearmanCorrelation">
                                    Spearman相关系数
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mutualInformation" checked>
                                <label class="form-check-label" for="mutualInformation">
                                    互信息
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="correlationMatrix" checked>
                                <label class="form-check-label" for="correlationMatrix">
                                    相关性矩阵
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 开始评估 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-play me-2"></i>步骤3: 开始评估
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <button class="btn btn-primary btn-lg" onclick="startEvaluation()" id="evaluateBtn">
                            <i class="fas fa-chart-line me-2"></i>开始质量评估
                        </button>
                    </div>
                    
                    <!-- 进度显示 -->
                    <div id="progressContainer" class="mt-4" style="display: none;">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progressBar">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-muted" id="progressMessage">正在初始化...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 评估结果 -->
    <div class="row" id="resultContainer" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>评估结果
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 总体评分 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="text-center">
                                <h4>总体质量评分</h4>
                                <div class="display-4 text-primary mb-3" id="overallScore">85.6</div>
                                <div class="progress mx-auto" style="width: 300px; height: 20px;">
                                    <div class="progress-bar bg-primary" style="width: 85.6%" id="overallProgress"></div>
                                </div>
                                <p class="text-muted mt-2">基于多个维度的综合评估</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 详细指标 -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">统计相似度</h6>
                                    <div class="mb-2">
                                        <small>均值相似度</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 92%">92%</div>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <small>方差相似度</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 88%">88%</div>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <small>偏度相似度</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" style="width: 76%">76%</div>
                                        </div>
                                    </div>
                                    <div class="mb-0">
                                        <small>峰度相似度</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" style="width: 82%">82%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">分布相似度</h6>
                                    <div class="mb-2">
                                        <small>KS检验</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 89%">89%</div>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <small>卡方检验</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 91%">91%</div>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <small>Wasserstein距离</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" style="width: 78%">78%</div>
                                        </div>
                                    </div>
                                    <div class="mb-0">
                                        <small>JS散度</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" style="width: 85%">85%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">相关性保持</h6>
                                    <div class="mb-2">
                                        <small>Pearson相关系数</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 87%">87%</div>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <small>Spearman相关系数</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 84%">84%</div>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <small>互信息</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" style="width: 79%">79%</div>
                                        </div>
                                    </div>
                                    <div class="mb-0">
                                        <small>相关性矩阵</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" style="width: 86%">86%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-success me-3" onclick="downloadReport()">
                            <i class="fas fa-download me-2"></i>下载报告
                        </button>
                        <button class="btn btn-info me-3" onclick="viewDetails()">
                            <i class="fas fa-chart-bar me-2"></i>查看详情
                        </button>
                        <button class="btn btn-secondary" onclick="saveEvaluation()">
                            <i class="fas fa-save me-2"></i>保存评估
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后初始化
$(document).ready(function() {
    loadDataSources();
});

// 加载数据源列表
async function loadDataSources() {
    try {
        const response = await fetch('/api/data-sources');
        const result = await response.json();
        
        if (result.success && result.data_sources) {
            const originalSelect = $('#originalDataSource');
            const syntheticSelect = $('#syntheticDataSource');
            
            result.data_sources.forEach(ds => {
                const option = `<option value="${ds.id}">${ds.name} (${ds.type})</option>`;
                originalSelect.append(option);
                syntheticSelect.append(option);
            });
        }
    } catch (error) {
        console.error('加载数据源失败:', error);
    }
}

// 开始评估
async function startEvaluation() {
    const originalDataSource = $('#originalDataSource').val();
    const syntheticDataSource = $('#syntheticDataSource').val();
    
    if (!originalDataSource || !syntheticDataSource) {
        showMessage('请选择原始数据源和合成数据源', 'error');
        return;
    }
    
    if (originalDataSource === syntheticDataSource) {
        showMessage('原始数据源和合成数据源不能相同', 'error');
        return;
    }
    
    // 显示进度
    $('#progressContainer').show();
    $('#evaluateBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>评估中...');
    
    // 模拟评估过程
    simulateEvaluation();
}

// 模拟评估过程
function simulateEvaluation() {
    const steps = [
        { progress: 15, message: '正在读取原始数据...' },
        { progress: 30, message: '正在读取合成数据...' },
        { progress: 45, message: '正在计算统计指标...' },
        { progress: 60, message: '正在分析分布相似度...' },
        { progress: 75, message: '正在评估相关性保持...' },
        { progress: 90, message: '正在生成评估报告...' },
        { progress: 100, message: '评估完成！' }
    ];
    
    let currentStep = 0;
    
    const interval = setInterval(() => {
        if (currentStep < steps.length) {
            const step = steps[currentStep];
            $('#progressBar').css('width', step.progress + '%');
            $('#progressText').text(step.progress + '%');
            $('#progressMessage').text(step.message);
            currentStep++;
        } else {
            clearInterval(interval);
            showEvaluationResult();
        }
    }, 800);
}

// 显示评估结果
function showEvaluationResult() {
    $('#progressContainer').hide();
    $('#resultContainer').show();
    $('#evaluateBtn').prop('disabled', false).html('<i class="fas fa-chart-line me-2"></i>开始质量评估');
    
    showMessage('质量评估完成！', 'success');
}

// 下载报告
function downloadReport() {
    showMessage('报告下载功能开发中...', 'info');
}

// 查看详情
function viewDetails() {
    showMessage('详情查看功能开发中...', 'info');
}

// 保存评估
function saveEvaluation() {
    showMessage('评估保存功能开发中...', 'info');
}

// 显示帮助
function showHelp() {
    showMessage('帮助文档开发中...', 'info');
}

// 显示历史记录
function showHistory() {
    showMessage('历史记录功能开发中...', 'info');
}
</script>
{% endblock %}