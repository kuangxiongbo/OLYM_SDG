{% extends "base.html" %}

{% block title %}结果展示 - SDG Web界面{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-bar"></i> 结果展示</h2>
        <p class="text-muted">查看合成数据生成结果和质量评估</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 生成信息</h5>
            </div>
            <div class="card-body" id="generation-info">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                    <p>加载中...</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> 下载结果</h5>
            </div>
            <div class="card-body" id="download-section">
                <div class="text-center text-muted">
                    <p>暂无结果文件</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> 合成数据预览</h5>
            </div>
            <div class="card-body">
                <div id="data-preview">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> 质量评估</h5>
            </div>
            <div class="card-body">
                <div id="quality-evaluation">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细评估模态框 -->
<div class="modal fade" id="detailedEvaluationModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar"></i> 详细质量评估
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailed-evaluation-content">
                <!-- 动态加载详细评估内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = null;
let currentResult = null;

// 页面加载时获取数据
document.addEventListener('DOMContentLoaded', function() {
    currentSessionId = localStorage.getItem('currentSessionId');
    
    // 获取最后的结果
    const lastResult = localStorage.getItem('lastResult');
    if (lastResult) {
        currentResult = JSON.parse(lastResult);
    }
    
    if (currentSessionId) {
        loadSessionData();
    } else {
        showNoDataMessage();
    }
});

// 加载会话数据
function loadSessionData() {
    fetch(`/get_session_data/${currentSessionId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayGenerationInfo(data);
            displayDataPreview(data.synthetic_data_info);
            displayQualityEvaluation(data.evaluation_results);
            displayDownloadSection(data.result_files);
        } else {
            showNoDataMessage();
        }
    })
    .catch(error => {
        console.error('加载会话数据失败:', error);
        showNoDataMessage();
    });
}

// 显示生成信息
function displayGenerationInfo(data) {
    const container = document.getElementById('generation-info');
    
    if (data.synthetic_data_info && data.synthetic_data_info.shape) {
        container.innerHTML = `
            <div class="row text-center">
                <div class="col-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">原始数据</h6>
                            <p class="card-text">${data.data_info.shape[0]} 行</p>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">合成数据</h6>
                            <p class="card-text">${data.synthetic_data_info.shape[0]} 行</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <h6>数据特征</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-columns"></i> 列数: ${data.synthetic_data_info.shape[1]}</li>
                    <li><i class="fas fa-calendar"></i> 生成时间: ${new Date().toLocaleString()}</li>
                </ul>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <p>暂无生成数据</p>
            </div>
        `;
    }
}

// 显示数据预览
function displayDataPreview(syntheticDataInfo) {
    const container = document.getElementById('data-preview');
    
    if (syntheticDataInfo && syntheticDataInfo.sample_data) {
        // 生成表格
        let tableHTML = `
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            ${syntheticDataInfo.columns.map(col => `<th>${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${syntheticDataInfo.sample_data.map(row => `
                            <tr>
                                ${syntheticDataInfo.columns.map(col => `<td>${row[col] || '-'}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <div class="text-muted text-center">
                <small>显示前5行数据，共${syntheticDataInfo.shape[0]}行</small>
            </div>
        `;
        
        container.innerHTML = tableHTML;
    } else {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <p>暂无合成数据预览</p>
            </div>
        `;
    }
}

// 显示质量评估
function displayQualityEvaluation(evaluationResults) {
    const container = document.getElementById('quality-evaluation');
    
    if (evaluationResults && evaluationResults.overall_score !== undefined) {
        const score = evaluationResults.overall_score;
        const scoreClass = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
        const scoreText = score >= 80 ? '优秀' : score >= 60 ? '良好' : '需要改进';
        
        container.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="card bg-${scoreClass} text-white">
                        <div class="card-body text-center">
                            <h3>${score.toFixed(1)}</h3>
                            <p class="mb-0">${scoreText}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="progress mb-2">
                        <div class="progress-bar bg-${scoreClass}" role="progressbar" 
                             style="width: ${score}%"></div>
                    </div>
                    <p class="text-muted mb-3">总体质量分数: ${score.toFixed(1)}/100</p>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-outline-primary btn-sm" onclick="showDetailedEvaluation()">
                            <i class="fas fa-chart-bar"></i> 详细评估
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="regenerateData()">
                            <i class="fas fa-redo"></i> 重新生成
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <p>暂无质量评估结果</p>
                <button class="btn btn-primary" onclick="evaluateData()">
                    <i class="fas fa-chart-bar"></i> 开始评估
                </button>
            </div>
        `;
    }
}

// 显示下载区域
function displayDownloadSection(resultFiles) {
    const container = document.getElementById('download-section');
    
    if (resultFiles && (resultFiles.csv || resultFiles.excel)) {
        let downloadHTML = '<div class="d-grid gap-2">';
        
        if (resultFiles.csv) {
            downloadHTML += `
                <a href="/download/${resultFiles.csv}" class="btn btn-outline-primary">
                    <i class="fas fa-file-csv"></i> 下载CSV
                </a>
            `;
        }
        
        if (resultFiles.excel) {
            downloadHTML += `
                <a href="/download/${resultFiles.excel}" class="btn btn-outline-success">
                    <i class="fas fa-file-excel"></i> 下载Excel
                </a>
            `;
        }
        
        downloadHTML += '</div>';
        container.innerHTML = downloadHTML;
    } else {
        container.innerHTML = `
            <div class="text-center text-muted">
                <p>暂无结果文件</p>
            </div>
        `;
    }
}

// 显示详细评估
function showDetailedEvaluation() {
    // 这里可以加载更详细的评估结果
    const modal = new bootstrap.Modal(document.getElementById('detailedEvaluationModal'));
    modal.show();
    
    // 模拟详细评估内容
    document.getElementById('detailed-evaluation-content').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>统计对比</h6>
                <p>详细的统计指标对比分析...</p>
            </div>
            <div class="col-md-6">
                <h6>分布相似性</h6>
                <p>数据分布相似性分析...</p>
            </div>
        </div>
    `;
}

// 重新生成数据
function regenerateData() {
    if (confirm('确定要重新生成数据吗？这将覆盖当前结果。')) {
        window.location.href = '/model_config';
    }
}

// 评估数据
function evaluateData() {
    if (!currentSessionId) {
        showAlert('会话已过期，请重新上传数据', 'warning');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 评估中...';
    button.disabled = true;
    
    fetch('/evaluate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: currentSessionId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayQualityEvaluation(data.evaluation_results);
            showAlert('数据质量评估完成！', 'success');
        } else {
            showAlert('评估失败: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('评估失败: ' + error, 'danger');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// 显示无数据消息
function showNoDataMessage() {
    document.getElementById('generation-info').innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <p>暂无数据</p>
            <a href="/data_source" class="btn btn-primary btn-sm">
                <i class="fas fa-upload"></i> 上传数据
            </a>
        </div>
    `;
    
    document.getElementById('data-preview').innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <p>请先上传数据并生成合成数据</p>
        </div>
    `;
    
    document.getElementById('quality-evaluation').innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <p>请先生成合成数据</p>
        </div>
    `;
}
</script>
{% endblock %}
