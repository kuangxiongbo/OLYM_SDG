{% extends "base_new.html" %}

{% block title %}个人资料 - SDG多账号控制系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="fas fa-user-cog me-2"></i>个人资料
            </h2>
        </div>
    </div>

    <div class="row">
        <!-- 个人信息 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>基本信息
                    </h5>
                </div>
                <div class="card-body">
                    <form id="profileForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">用户名</label>
                                    <input type="text" class="form-control" id="username" value="{{ current_user.username }}" readonly>
                                    <div class="form-text">用户名不可修改</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">邮箱地址</label>
                                    <input type="email" class="form-control" id="email" value="{{ current_user.email }}" readonly>
                                    <div class="form-text">邮箱不可修改</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">用户角色</label>
                                    <input type="text" class="form-control" id="role" value="{{ current_user.role }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status" class="form-label">账户状态</label>
                                    <input type="text" class="form-control" id="status" value="{{ current_user.status }}" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="createdAt" class="form-label">注册时间</label>
                                    <input type="text" class="form-control" id="createdAt" value="{{ current_user.created_at.strftime('%Y-%m-%d %H:%M:%S') if current_user.created_at else '未知' }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lastLogin" class="form-label">最后登录</label>
                                    <input type="text" class="form-control" id="lastLogin" value="{{ current_user.last_login.strftime('%Y-%m-%d %H:%M:%S') if current_user.last_login else '未知' }}" readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 账户统计 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>账户统计
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="border-end">
                                <div class="display-6 text-primary" id="dataSourceCount">0</div>
                                <small class="text-muted">数据源</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="display-6 text-success" id="configCount">0</div>
                            <small class="text-muted">模型配置</small>
                        </div>
                        <div class="col-6">
                            <div class="border-end">
                                <div class="display-6 text-info" id="taskCount">0</div>
                                <small class="text-muted">任务数量</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="display-6 text-warning" id="storageUsed">0MB</div>
                            <small class="text-muted">存储使用</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 密码修改 -->
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lock me-2"></i>修改密码
                    </h5>
                </div>
                <div class="card-body">
                    <form id="passwordForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">当前密码</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">新密码</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                    <div class="form-text">至少8位，包含大小写字母、数字和特殊字符</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">确认新密码</label>
                                    <input type="password" class="form-control" id="confirmPassword" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary" onclick="changePassword()">
                                        <i class="fas fa-key me-2"></i>修改密码
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 账户设置 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>账户设置
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                            <label class="form-check-label" for="emailNotifications">
                                邮件通知
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="taskNotifications" checked>
                            <label class="form-check-label" for="taskNotifications">
                                任务通知
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="systemUpdates">
                            <label class="form-check-label" for="systemUpdates">
                                系统更新通知
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button class="btn btn-outline-primary" onclick="saveSettings()">
                            <i class="fas fa-save me-2"></i>保存设置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 账户操作 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>危险操作
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>导出数据</h6>
                            <p class="text-muted small">导出您的所有数据，包括数据源、配置和任务记录</p>
                            <button class="btn btn-outline-info" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>导出数据
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>删除账户</h6>
                            <p class="text-muted small">永久删除您的账户和所有相关数据，此操作不可撤销</p>
                            <button class="btn btn-outline-danger" onclick="deleteAccount()">
                                <i class="fas fa-trash me-2"></i>删除账户
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后初始化
$(document).ready(function() {
    loadUserStats();
});

// 加载用户统计信息
async function loadUserStats() {
    try {
        // 模拟数据
        $('#dataSourceCount').text('3');
        $('#configCount').text('2');
        $('#taskCount').text('15');
        $('#storageUsed').text('125MB');
    } catch (error) {
        console.error('加载统计信息失败:', error);
    }
}

// 修改密码
async function changePassword() {
    const currentPassword = $('#currentPassword').val();
    const newPassword = $('#newPassword').val();
    const confirmPassword = $('#confirmPassword').val();
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showMessage('请填写所有密码字段', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showMessage('两次输入的新密码不一致', 'error');
        return;
    }
    
    if (!validatePassword(newPassword)) {
        showMessage('新密码强度不足，需要至少8位，包含大小写字母、数字和特殊字符', 'error');
        return;
    }
    
    try {
        showMessage('密码修改成功', 'success');
        $('#passwordForm')[0].reset();
    } catch (error) {
        console.error('修改密码失败:', error);
        showMessage('修改密码失败', 'error');
    }
}

// 保存设置
async function saveSettings() {
    const settings = {
        emailNotifications: $('#emailNotifications').is(':checked'),
        taskNotifications: $('#taskNotifications').is(':checked'),
        systemUpdates: $('#systemUpdates').is(':checked')
    };
    
    try {
        showMessage('设置保存成功', 'success');
    } catch (error) {
        console.error('保存设置失败:', error);
        showMessage('保存设置失败', 'error');
    }
}

// 导出数据
function exportData() {
    showMessage('数据导出功能开发中...', 'info');
}

// 删除账户
function deleteAccount() {
    if (!confirm('确定要删除您的账户吗？此操作不可撤销，将删除您的所有数据！')) {
        return;
    }
    
    if (!confirm('请再次确认：您真的要删除账户吗？')) {
        return;
    }
    
    showMessage('账户删除功能开发中...', 'warning');
}
</script>
{% endblock %}

