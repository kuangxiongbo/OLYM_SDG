{% extends "base.html" %}

{% block title %}批量处理 - SDG Web界面{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tasks"></i> 批量处理</h2>
        <p class="text-muted">批量处理多个数据集，提高处理效率</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-upload"></i> 批量上传</h5>
            </div>
            <div class="card-body">
                <form id="batch-upload-form">
                    <div class="mb-3">
                        <label for="batch-files" class="form-label">选择多个文件</label>
                        <input type="file" class="form-control" id="batch-files" multiple accept=".csv,.xlsx,.xls">
                        <div class="form-text">支持同时上传多个CSV、Excel文件</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">处理选项</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto-clean" checked>
                            <label class="form-check-label" for="auto-clean">
                                自动数据清洗
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto-evaluate" checked>
                            <label class="form-check-label" for="auto-evaluate">
                                自动质量评估
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> 批量上传
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> 批量配置</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">模型类型</label>
                    <select class="form-select" id="batch-model-type">
                        <option value="ctgan">CTGAN (推荐)</option>
                        <option value="gpt">GPT (需要API密钥)</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">生成数量</label>
                    <input type="number" class="form-control" id="batch-num-samples" value="100" min="10" max="10000">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">并发处理数</label>
                    <input type="number" class="form-control" id="batch-concurrency" value="3" min="1" max="10">
                    <div class="form-text">同时处理的数据集数量</div>
                </div>
                
                <div id="batch-model-config">
                    <!-- 动态加载模型配置 -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> 处理队列</h5>
                <div>
                    <button class="btn btn-sm btn-success" onclick="startBatchProcessing()" id="start-batch-btn">
                        <i class="fas fa-play"></i> 开始处理
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="pauseBatchProcessing()" id="pause-batch-btn" style="display: none;">
                        <i class="fas fa-pause"></i> 暂停
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="stopBatchProcessing()" id="stop-batch-btn" style="display: none;">
                        <i class="fas fa-stop"></i> 停止
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="batch-queue">
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>暂无处理任务</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> 处理进度</h5>
            </div>
            <div class="card-body">
                <div id="batch-progress">
                    <div class="text-center text-muted">
                        <p>等待开始处理...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> 结果下载</h5>
            </div>
            <div class="card-body">
                <div id="batch-results">
                    <div class="text-center text-muted">
                        <p>暂无处理结果</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 批量处理详情模态框 -->
<div class="modal fade" id="batchDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> 处理详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="batch-detail-content">
                <!-- 动态加载详情内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let batchQueue = [];
let batchResults = [];
let isProcessing = false;
let currentBatchIndex = 0;

// 批量上传处理
document.getElementById('batch-upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const files = document.getElementById('batch-files').files;
    if (files.length === 0) {
        showAlert('请选择文件', 'warning');
        return;
    }
    
    // 处理每个文件
    Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = parseFileData(e.target.result, file.name);
                addToBatchQueue({
                    id: generateId('batch'),
                    filename: file.name,
                    data: data,
                    status: 'pending',
                    progress: 0,
                    result: null,
                    error: null
                });
            } catch (error) {
                showAlert(`文件 ${file.name} 解析失败: ${error.message}`, 'danger');
            }
        };
        reader.readAsText(file);
    });
});

// 解析文件数据
function parseFileData(content, filename) {
    if (filename.endsWith('.csv')) {
        return parseCSV(content);
    } else if (filename.endsWith('.xlsx') || filename.endsWith('.xls')) {
        // 对于Excel文件，需要特殊处理
        throw new Error('Excel文件需要转换为CSV格式');
    } else {
        throw new Error('不支持的文件格式');
    }
}

// 解析CSV数据
function parseCSV(content) {
    const lines = content.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
            const values = lines[i].split(',').map(v => v.trim());
            const row = {};
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            data.push(row);
        }
    }
    
    return data;
}

// 添加到批量队列
function addToBatchQueue(item) {
    batchQueue.push(item);
    updateBatchQueueDisplay();
}

// 更新批量队列显示
function updateBatchQueueDisplay() {
    const container = document.getElementById('batch-queue');
    
    if (batchQueue.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-inbox fa-2x mb-3"></i>
                <p>暂无处理任务</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += `
        <thead>
            <tr>
                <th>文件名</th>
                <th>数据量</th>
                <th>状态</th>
                <th>进度</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    batchQueue.forEach((item, index) => {
        const statusClass = getStatusClass(item.status);
        const statusIcon = getStatusIcon(item.status);
        
        html += `
            <tr>
                <td>${item.filename}</td>
                <td>${item.data.length} 行</td>
                <td>
                    <span class="badge bg-${statusClass}">
                        <i class="fas fa-${statusIcon}"></i> ${item.status}
                    </span>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" style="width: ${item.progress}%">
                            ${item.progress}%
                        </div>
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewBatchDetail(${index})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromBatch(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// 获取状态样式类
function getStatusClass(status) {
    const statusClasses = {
        'pending': 'secondary',
        'processing': 'primary',
        'completed': 'success',
        'failed': 'danger',
        'paused': 'warning'
    };
    return statusClasses[status] || 'secondary';
}

// 获取状态图标
function getStatusIcon(status) {
    const statusIcons = {
        'pending': 'clock',
        'processing': 'spinner fa-spin',
        'completed': 'check',
        'failed': 'times',
        'paused': 'pause'
    };
    return statusIcons[status] || 'question';
}

// 开始批量处理
function startBatchProcessing() {
    if (batchQueue.length === 0) {
        showAlert('处理队列为空', 'warning');
        return;
    }
    
    isProcessing = true;
    currentBatchIndex = 0;
    
    // 更新按钮状态
    document.getElementById('start-batch-btn').style.display = 'none';
    document.getElementById('pause-batch-btn').style.display = 'inline-block';
    document.getElementById('stop-batch-btn').style.display = 'inline-block';
    
    // 开始处理
    processNextBatch();
}

// 处理下一个批次
function processNextBatch() {
    if (!isProcessing || currentBatchIndex >= batchQueue.length) {
        finishBatchProcessing();
        return;
    }
    
    const concurrency = parseInt(document.getElementById('batch-concurrency').value);
    const endIndex = Math.min(currentBatchIndex + concurrency, batchQueue.length);
    
    // 并发处理多个任务
    const promises = [];
    for (let i = currentBatchIndex; i < endIndex; i++) {
        promises.push(processBatchItem(i));
    }
    
    Promise.all(promises).then(() => {
        currentBatchIndex = endIndex;
        if (isProcessing) {
            setTimeout(processNextBatch, 1000); // 延迟1秒后处理下一批
        }
    });
}

// 处理单个批次项目
async function processBatchItem(index) {
    const item = batchQueue[index];
    item.status = 'processing';
    item.progress = 0;
    updateBatchQueueDisplay();
    
    try {
        // 模拟处理过程
        for (let progress = 0; progress <= 100; progress += 10) {
            if (!isProcessing) break;
            
            item.progress = progress;
            updateBatchQueueDisplay();
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // 实际的数据生成处理
        const modelType = document.getElementById('batch-model-type').value;
        const numSamples = parseInt(document.getElementById('batch-num-samples').value);
        
        // 这里应该调用实际的API
        const result = await generateSyntheticDataAPI(item.data, modelType, numSamples);
        
        item.status = 'completed';
        item.progress = 100;
        item.result = result;
        
        batchResults.push({
            filename: item.filename,
            originalData: item.data,
            syntheticData: result.synthetic_data,
            evaluation: result.evaluation
        });
        
    } catch (error) {
        item.status = 'failed';
        item.error = error.message;
    }
    
    updateBatchQueueDisplay();
    updateBatchProgress();
    updateBatchResults();
}

// 模拟API调用
async function generateSyntheticDataAPI(data, modelType, numSamples) {
    // 这里应该调用实际的API
    // 现在只是模拟返回结果
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    return {
        synthetic_data: data.map(item => ({
            ...item,
            id: Math.random().toString(36).substr(2, 9)
        })),
        evaluation: {
            overall_score: Math.random() * 40 + 60, // 60-100分
            metrics: {
                statistical_similarity: { score: Math.random() * 40 + 60 },
                distribution_similarity: { score: Math.random() * 40 + 60 }
            }
        }
    };
}

// 完成批量处理
function finishBatchProcessing() {
    isProcessing = false;
    
    // 更新按钮状态
    document.getElementById('start-batch-btn').style.display = 'inline-block';
    document.getElementById('pause-batch-btn').style.display = 'none';
    document.getElementById('stop-batch-btn').style.display = 'none';
    
    // 显示完成统计
    const completed = batchQueue.filter(item => item.status === 'completed').length;
    const failed = batchQueue.filter(item => item.status === 'failed').length;
    
    showAlert(`批量处理完成！成功: ${completed}, 失败: ${failed}`, 'success');
}

// 暂停批量处理
function pauseBatchProcessing() {
    isProcessing = false;
    
    // 更新按钮状态
    document.getElementById('start-batch-btn').style.display = 'inline-block';
    document.getElementById('pause-batch-btn').style.display = 'none';
    document.getElementById('stop-batch-btn').style.display = 'none';
    
    // 更新状态
    batchQueue.forEach(item => {
        if (item.status === 'processing') {
            item.status = 'paused';
        }
    });
    
    updateBatchQueueDisplay();
    showAlert('批量处理已暂停', 'warning');
}

// 停止批量处理
function stopBatchProcessing() {
    isProcessing = false;
    
    // 更新按钮状态
    document.getElementById('start-batch-btn').style.display = 'inline-block';
    document.getElementById('pause-batch-btn').style.display = 'none';
    document.getElementById('stop-batch-btn').style.display = 'none';
    
    // 更新状态
    batchQueue.forEach(item => {
        if (item.status === 'processing') {
            item.status = 'failed';
            item.error = '用户停止';
        }
    });
    
    updateBatchQueueDisplay();
    showAlert('批量处理已停止', 'danger');
}

// 更新批量进度
function updateBatchProgress() {
    const container = document.getElementById('batch-progress');
    
    if (batchQueue.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>等待开始处理...</p></div>';
        return;
    }
    
    const total = batchQueue.length;
    const completed = batchQueue.filter(item => item.status === 'completed').length;
    const failed = batchQueue.filter(item => item.status === 'failed').length;
    const processing = batchQueue.filter(item => item.status === 'processing').length;
    
    const progress = total > 0 ? ((completed + failed) / total) * 100 : 0;
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <div class="progress mb-2">
                    <div class="progress-bar" role="progressbar" style="width: ${progress}%">
                        ${progress.toFixed(1)}%
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <small class="text-muted">${completed + failed}/${total}</small>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h5 text-success">${completed}</div>
                    <small>已完成</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h5 text-danger">${failed}</div>
                    <small>失败</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h5 text-primary">${processing}</div>
                    <small>处理中</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h5 text-secondary">${total - completed - failed - processing}</div>
                    <small>等待中</small>
                </div>
            </div>
        </div>
    `;
}

// 更新批量结果
function updateBatchResults() {
    const container = document.getElementById('batch-results');
    
    if (batchResults.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><p>暂无处理结果</p></div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += `
        <thead>
            <tr>
                <th>文件名</th>
                <th>原始数据</th>
                <th>合成数据</th>
                <th>质量分数</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    batchResults.forEach((result, index) => {
        const score = result.evaluation.overall_score;
        const scoreClass = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
        
        html += `
            <tr>
                <td>${result.filename}</td>
                <td>${result.originalData.length} 行</td>
                <td>${result.syntheticData.length} 行</td>
                <td>
                    <span class="badge bg-${scoreClass}">
                        ${score.toFixed(1)}/100
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="downloadBatchResult(${index})">
                        <i class="fas fa-download"></i> 下载
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewBatchResult(${index})">
                        <i class="fas fa-eye"></i> 查看
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// 查看批量详情
function viewBatchDetail(index) {
    const item = batchQueue[index];
    const modal = new bootstrap.Modal(document.getElementById('batchDetailModal'));
    
    document.getElementById('batch-detail-content').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>基本信息</h6>
                <ul class="list-unstyled">
                    <li><strong>文件名:</strong> ${item.filename}</li>
                    <li><strong>数据量:</strong> ${item.data.length} 行</li>
                    <li><strong>状态:</strong> <span class="badge bg-${getStatusClass(item.status)}">${item.status}</span></li>
                    <li><strong>进度:</strong> ${item.progress}%</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>数据预览</h6>
                <div class="table-responsive" style="max-height: 200px;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                ${Object.keys(item.data[0] || {}).map(key => `<th>${key}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${item.data.slice(0, 5).map(row => `
                                <tr>
                                    ${Object.values(row).map(value => `<td>${value}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        ${item.error ? `<div class="alert alert-danger mt-3"><strong>错误:</strong> ${item.error}</div>` : ''}
    `;
    
    modal.show();
}

// 从批量队列中移除
function removeFromBatch(index) {
    if (confirm('确定要移除此任务吗？')) {
        batchQueue.splice(index, 1);
        updateBatchQueueDisplay();
        updateBatchProgress();
    }
}

// 下载批量结果
function downloadBatchResult(index) {
    const result = batchResults[index];
    const csvContent = convertToCSV(result.syntheticData);
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `synthetic_${result.filename}`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// 查看批量结果
function viewBatchResult(index) {
    const result = batchResults[index];
    // 这里可以打开一个新的模态框显示结果详情
    showAlert(`查看结果: ${result.filename}`, 'info');
}

// 转换为CSV格式
function convertToCSV(data) {
    if (data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => row[header] || '').join(','))
    ].join('\n');
    
    return csvContent;
}

// 生成ID
function generateId(prefix) {
    return prefix + '_' + Math.random().toString(36).substr(2, 9);
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    updateBatchQueueDisplay();
    updateBatchProgress();
    updateBatchResults();
});
</script>
{% endblock %}
