<!DOCTYPE html>
<html>
<head>
    <title>配置保存验证</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .config-display { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; border: 1px solid #dee2e6; }
        .test-section { border-left: 4px solid #007bff; padding-left: 15px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 DeepSeek本地模型配置保存验证</h1>
        
        <div class="card">
            <h2>📝 配置输入</h2>
            <div class="form-group">
                <label for="local-url">本地API地址:</label>
                <input type="text" id="local-url" value="http://192.168.210.209:11434/api/generate" placeholder="输入本地API地址">
            </div>
            <div class="form-group">
                <label for="local-model">模型名称:</label>
                <input type="text" id="local-model" value="deepseek-r1" placeholder="输入模型名称">
            </div>
            <div class="form-group">
                <label for="local-timeout">超时时间(秒):</label>
                <input type="number" id="local-timeout" value="30" min="5" max="300">
            </div>
            <button onclick="saveConfig()">💾 保存配置</button>
            <button onclick="loadConfig()">📂 加载配置</button>
            <button onclick="clearConfig()">🗑️ 清除配置</button>
            <button onclick="runFullTest()">🧪 运行完整测试</button>
        </div>
        
        <div class="card">
            <h2>📊 当前配置状态</h2>
            <div id="config-display" class="config-display">暂无配置数据</div>
        </div>
        
        <div class="card">
            <h2>🧪 测试结果</h2>
            <div id="test-results"></div>
        </div>
        
        <div class="card">
            <h2>📋 测试步骤说明</h2>
            <div class="test-section">
                <h3>步骤1: 保存配置</h3>
                <p>点击"保存配置"按钮，将当前输入的配置保存到localStorage中。</p>
            </div>
            <div class="test-section">
                <h3>步骤2: 加载配置</h3>
                <p>点击"加载配置"按钮，从localStorage中读取之前保存的配置并填充到表单中。</p>
            </div>
            <div class="test-section">
                <h3>步骤3: 验证持久化</h3>
                <p>刷新页面后，配置应该自动加载并显示在表单中。</p>
            </div>
        </div>
    </div>

    <script>
        // 保存配置函数
        function saveConfig() {
            const config = {
                url: document.getElementById('local-url').value,
                model: document.getElementById('local-model').value,
                timeout: document.getElementById('local-timeout').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('local_config', JSON.stringify(config));
                showResult('✅ 配置保存成功！', 'success');
                displayConfig();
                logTest('保存配置', '成功', config);
            } catch (error) {
                showResult('❌ 配置保存失败: ' + error.message, 'error');
                logTest('保存配置', '失败', error.message);
            }
        }
        
        // 加载配置函数
        function loadConfig() {
            try {
                const config = localStorage.getItem('local_config');
                if (config) {
                    const parsedConfig = JSON.parse(config);
                    document.getElementById('local-url').value = parsedConfig.url || '';
                    document.getElementById('local-model').value = parsedConfig.model || '';
                    document.getElementById('local-timeout').value = parsedConfig.timeout || 30;
                    showResult('✅ 配置加载成功！', 'success');
                    displayConfig();
                    logTest('加载配置', '成功', parsedConfig);
                } else {
                    showResult('⚠️ 没有找到保存的配置', 'info');
                    logTest('加载配置', '无数据', 'localStorage中没有local_config');
                }
            } catch (error) {
                showResult('❌ 配置加载失败: ' + error.message, 'error');
                logTest('加载配置', '失败', error.message);
            }
        }
        
        // 清除配置函数
        function clearConfig() {
            localStorage.removeItem('local_config');
            document.getElementById('local-url').value = '';
            document.getElementById('local-model').value = '';
            document.getElementById('local-timeout').value = '30';
            showResult('🗑️ 配置已清除', 'info');
            displayConfig();
            logTest('清除配置', '成功', 'localStorage已清空');
        }
        
        // 显示配置
        function displayConfig() {
            const config = localStorage.getItem('local_config');
            if (config) {
                const parsedConfig = JSON.parse(config);
                document.getElementById('config-display').textContent = 
                    '配置数据:\n' + JSON.stringify(parsedConfig, null, 2);
            } else {
                document.getElementById('config-display').textContent = '暂无配置数据';
            }
        }
        
        // 显示结果
        function showResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const resultElement = document.createElement('div');
            resultElement.className = type;
            resultElement.textContent = message;
            resultsDiv.appendChild(resultElement);
            
            // 滚动到结果区域
            resultElement.scrollIntoView({ behavior: 'smooth' });
            
            // 5秒后移除结果
            setTimeout(() => {
                if (resultElement.parentNode) {
                    resultElement.remove();
                }
            }, 5000);
        }
        
        // 记录测试日志
        function logTest(action, result, data) {
            console.log(`[${new Date().toLocaleTimeString()}] ${action}: ${result}`, data);
        }
        
        // 运行完整测试
        function runFullTest() {
            showResult('🧪 开始运行完整测试...', 'info');
            
            // 测试1: localStorage可用性
            try {
                const testKey = 'test_' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                showResult('✅ localStorage可用性测试通过', 'success');
                logTest('localStorage可用性', '通过', '正常');
            } catch (error) {
                showResult('❌ localStorage不可用: ' + error.message, 'error');
                logTest('localStorage可用性', '失败', error.message);
                return;
            }
            
            // 测试2: 保存配置
            setTimeout(() => {
                saveConfig();
            }, 500);
            
            // 测试3: 加载配置
            setTimeout(() => {
                loadConfig();
            }, 1000);
            
            // 测试4: 验证数据完整性
            setTimeout(() => {
                const config = localStorage.getItem('local_config');
                if (config) {
                    const parsedConfig = JSON.parse(config);
                    if (parsedConfig.url && parsedConfig.model && parsedConfig.timeout) {
                        showResult('✅ 数据完整性验证通过', 'success');
                        logTest('数据完整性', '通过', parsedConfig);
                    } else {
                        showResult('❌ 数据完整性验证失败', 'error');
                        logTest('数据完整性', '失败', '缺少必要字段');
                    }
                } else {
                    showResult('❌ 数据完整性验证失败: 没有找到配置', 'error');
                    logTest('数据完整性', '失败', '没有找到配置');
                }
            }, 1500);
        }
        
        // 页面加载时自动显示当前配置
        window.onload = function() {
            displayConfig();
            showResult('📄 页面加载完成，可以开始测试配置保存功能', 'info');
        };
        
        // 监听表单变化
        document.addEventListener('input', function(e) {
            if (e.target.id === 'local-url' || e.target.id === 'local-model' || e.target.id === 'local-timeout') {
                // 可以在这里添加实时验证逻辑
            }
        });
    </script>
</body>
</html>
